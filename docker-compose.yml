version: '3'

services:
  traefik:
    image: traefik
    command: --api --docker --loglevel=INFO
    ports:
      - 80:80
      - 443:443
      - 8080:8080 # for monitoring dashboard
    networks:
      - traefik
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  rabbitmq:
    image: rabbitmq:3-management-alpine
    hostname: rabbitmq
    networks:
      - internal
    volumes:
      - ./data/rabbitmq:/var/lib/rabbitmq/mnesia/rabbit@rabbitmq
    ports:
      - 15672:15672 # management panel

  APIGateway:
    image: gakkoservices/apigateway
    build:
      context: .
      dockerfile: Dockerfile-aspnetcore
      args:
        - name=GakkoServices.APIGateway
        - BUILD_ENVIRONMENT=Release
    networks:
      - internal
      - traefik
    labels:
      traefik.docker.network: ${COMPOSE_PROJECT_NAME}_traefik
      traefik.frontend.rule: PathPrefixStrip:/api
      traefik.port: 80

  AuthServer:
    image: gakkoservices/authserver
    build:
      context: .
      dockerfile: Dockerfile-aspnetcore
      args:
        - name=GakkoServices.AuthServer
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
    networks:
      - internal
      - traefik
      - authserver_db_network
    depends_on:
      - AuthServerDB
    labels:
      traefik.docker.network: ${COMPOSE_PROJECT_NAME}_traefik
      traefik.frontend.rule: PathPrefixStrip:/auth
      traefik.port: 80

  AuthServerDB:
    image: mysql:latest
    networks:
      - authserver_db_network
    labels:
      traefik.enable: false # TODO: database password?

networks:
  traefik:
    external: false
  internal:
    external: false
  authserver_db_network:
    external: false
